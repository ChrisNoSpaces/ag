<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zone Map Manager</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #475569;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-dark) 100%);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .map-section {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .zone-panel {
            width: 280px;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            padding: 1rem;
            overflow-y: auto;
        }

        .zone-panel h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .zone-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-input);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .zone-item:hover {
            background: var(--border);
        }

        .zone-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 0.75rem;
        }

        .zone-name {
            flex: 1;
            font-size: 0.9rem;
        }

        .zone-count {
            background: var(--bg-dark);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .zone-actions {
            margin-left: 0.5rem;
            display: flex;
            gap: 0.25rem;
        }

        .zone-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 0.8rem;
        }

        .zone-btn:hover {
            color: var(--text-primary);
        }

        .bottom-panel {
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            max-height: 40vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .panel-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-group label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        select, input[type="text"], input[type="number"], input[type="password"] {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .address-list {
            overflow-y: auto;
            flex: 1;
            padding: 1rem 1.5rem;
        }

        .address-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .address-item:hover {
            background: var(--border);
        }

        .address-zone-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .address-info {
            flex: 1;
            min-width: 0;
        }

        .address-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .address-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .address-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .address-actions .btn {
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .form-group input, .form-group select {
            width: 100%;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-card) 100%);
        }

        .login-box {
            background: var(--bg-card);
            padding: 3rem;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
        }

        .login-box p {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .login-box .form-group {
            margin-bottom: 1.5rem;
        }

        .login-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .divider {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin: 1rem 0;
        }

        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .hidden {
            display: none !important;
        }

        /* Custom Leaflet Popup */
        .leaflet-popup-content-wrapper {
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 8px;
        }

        .leaflet-popup-tip {
            background: var(--bg-card);
        }

        .popup-content {
            padding: 0.5rem;
        }

        .popup-content h4 {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .popup-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .popup-content .btn {
            margin-top: 0.5rem;
            width: 100%;
            justify-content: center;
        }

        .settings-section {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .settings-section h4 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .max-per-zone-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .max-per-zone-control label {
            flex: 1;
            font-size: 0.9rem;
        }

        .max-per-zone-control input {
            width: 80px;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-card);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: none;
            z-index: 2000;
            border-left: 4px solid var(--secondary);
        }

        .toast.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .zone-panel {
                width: 100%;
                max-height: 200px;
                border-left: none;
                border-top: 1px solid var(--border);
            }

            .bottom-panel {
                max-height: 50vh;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1>üó∫Ô∏è Zone Map Manager</h1>
            <p>Organize your locations into zones</p>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchLoginTab('login')">Login</button>
                <button class="tab-btn" onclick="switchLoginTab('register')">Create Account</button>
            </div>

            <div id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password">
                </div>
                <button class="btn btn-primary" style="width: 100%" onclick="login()">Login</button>
            </div>

            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="regUsername" placeholder="Choose username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="regPassword" placeholder="Choose password">
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="regConfirmPassword" placeholder="Confirm password">
                </div>
                <button class="btn btn-primary" style="width: 100%" onclick="register()">Create Account</button>
            </div>

            <div class="divider">or</div>

            <button class="btn btn-secondary" style="width: 100%" onclick="continueAsGuest()">Continue as Guest</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app-container hidden">
        <header class="header">
            <div class="logo">Zone Map Manager</div>
            <div class="user-section">
                <span class="user-info" id="userDisplay">Welcome, Guest</span>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="main-content">
            <div class="map-section">
                <div id="map"></div>
            </div>

            <div class="zone-panel">
                <h3>Zones</h3>
                <div id="zoneList"></div>

                <div class="settings-section">
                    <h4>Zone Settings</h4>
                    <div class="max-per-zone-control">
                        <label>Max locations per zone:</label>
                        <input type="number" id="maxPerZone" value="15" min="1" max="50" onchange="updateMaxPerZone()">
                    </div>
                    <button class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem" onclick="openAddZoneModal()">+ Add Zone</button>
                    <button class="btn btn-primary" style="width: 100%" onclick="recalibrateZones()">Recalibrate All</button>
                </div>
            </div>
        </div>

        <div class="bottom-panel">
            <div class="panel-header">
                <div class="panel-title">Locations (<span id="locationCount">0</span>)</div>
                <div class="panel-controls">
                    <div class="control-group">
                        <label>Sort by:</label>
                        <select id="sortBy" onchange="renderAddressList()">
                            <option value="name">Name</option>
                            <option value="zone">Zone</option>
                            <option value="address">Address</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="openAddAddressModal()">+ Add Address</button>
                </div>
            </div>
            <div class="address-list" id="addressList"></div>
        </div>
    </div>

    <!-- Edit Address Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <h2 id="editModalTitle">Edit Location</h2>
            <div class="form-group">
                <label>Business Name</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label>Address</label>
                <input type="text" id="editAddress">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Latitude</label>
                    <input type="text" id="editLat">
                </div>
                <div class="form-group">
                    <label>Longitude</label>
                    <input type="text" id="editLng">
                </div>
            </div>
            <div class="form-group">
                <label>Zone Assignment</label>
                <select id="editZone">
                    <option value="auto">Auto-assign</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('editModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveLocation()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Zone Modal -->
    <div class="modal-overlay" id="zoneModal">
        <div class="modal">
            <h2 id="zoneModalTitle">Add Zone</h2>
            <div class="form-group">
                <label>Zone Name</label>
                <input type="text" id="zoneName">
            </div>
            <div class="form-group">
                <label>Zone Color</label>
                <input type="color" id="zoneColor" value="#6366f1" style="width: 100%; height: 40px; border: none; cursor: pointer;">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('zoneModal')">Cancel</button>
                <button class="btn btn-danger hidden" id="deleteZoneBtn" onclick="deleteZone()">Delete Zone</button>
                <button class="btn btn-primary" onclick="saveZone()">Save Zone</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // ========== DATA ==========
        const OWNER_CREDENTIALS = { username: 'chris', password: 'beaver' };

        const PRESET_LOCATIONS = [{"name": "Capital Flooring Inc", "address": "46969 West Rd, Wixom, MI 48393"}, {"name": "Leslie McGwire & Associates", "address": "4301 Orchard Lake Rd, West Bloomfield Township, MI 48323"}, {"name": "Gumma Group", "address": "7419 Middlebelt Rd # 4, West Bloomfield Township, MI 48322"}, {"name": "DKI Demolition", "address": "6775 Daly Rd Suite#101, West Bloomfield Township, MI 48322"}, {"name": "Independence Commercial Construction, Inc.", "address": "2635 Dixie Hwy, Waterford Township, MI 48328"}, {"name": "Wolverine Stone Co", "address": "27270 Gloede Dr, Warren, MI 48088"}, {"name": "Wakely Associates", "address": "30500 Van Dyke Ave, Warren, MI 48093"}, {"name": "Villa Carpets, Inc", "address": "30000 Ryan Rd, Warren, MI 48092"}, {"name": "Son Shine Floor Covering", "address": "31065 Ryan Rd, Warren, MI 48092"}, {"name": "Ross & Barr Inc", "address": "11800 E 9 Mile Rd, Warren, MI 48089"}, {"name": "Motor City Carpet & Flooring", "address": "23957 Ryan Rd, Warren, MI 48091"}, {"name": "MGC Granite & Design", "address": "14230 E 11 Mile Rd, Warren, MI 48089"}, {"name": "Dapco Central Operations Office", "address": "11020 E 9 Mile Rd, Warren, MI 48089"}, {"name": "Creative Building & Remodeling", "address": "26820 Dequindre Rd, Warren, MI 48091"}, {"name": "Brencal Contractors Inc", "address": "26079 Schoenherr Rd, Warren, MI 48089"}, {"name": "Stonescape Supply", "address": "4454 22 Mile Rd, Shelby Township, MI 48317"}, {"name": "Beninati Custom Pools, Swim Spas and Hot Tubs", "address": "6991 Auburn Rd, Utica, MI 48317"}, {"name": "Zac Cruse Construction Company", "address": "4150 Lincoln St, Detroit, MI 48208"}, {"name": "Your Choice Flooring Inc", "address": "1409 Allen Dr # E, Troy, MI 48083"}, {"name": "Ruth Casper Design Studio", "address": "1700 Stutz Dr # 102E, Troy, MI 48084"}, {"name": "Quality Tile", "address": "3331 Gerald Ave, Rochester Hills, MI 48307"}, {"name": "PMP Marble & Granite", "address": "1360 E Big Beaver Rd, Troy, MI 48083"}, {"name": "Peter Basso Associates Inc", "address": "5145 Livernois Rd #100, Troy, MI 48098"}, {"name": "Office Express", "address": "1280 E Big Beaver Rd, Troy, MI 48083"}, {"name": "National Business Supply", "address": "2595 Bellingham Rd, Troy, MI 48083"}, {"name": "Mondrian Properties LLC.", "address": "2113 Kohli Dr, Troy, MI 48083"}, {"name": "M & N General Contracting LLC", "address": "972 Rankin St, Troy, MI 48083"}, {"name": "Michigan Multi-King Inc", "address": "4897 Rochester Rd, Troy, MI 48085"}, {"name": "Joseph Philip Craig Inc", "address": "2025 W Long Lake Rd, Troy, MI 48098"}, {"name": "Integrated Design Solutions", "address": "1441 W Long Lake Rd #200, Troy, MI 48098"}, {"name": "Gold Star Commercial, INC", "address": "264 Executive Dr, Troy, MI 48083"}, {"name": "Gio-Con", "address": "2145 Crooks Rd #210, Troy, MI 48084"}, {"name": "Gillete Brothers Pool & Spa", "address": "392 Oliver, Troy, MI 48084"}, {"name": "Fairview Construction", "address": "1700 W Big Beaver Rd #120, Troy, MI 48084"}, {"name": "Excel Floors, Inc", "address": "1715 Larchwood Ave, Troy, MI 48083"}, {"name": "Ehresman Architects", "address": "801 W Big Beaver Rd #250, Troy, MI 48084"}, {"name": "Cutting Edge Stonecraft, Inc.", "address": "24420 Indoplex Cir, Farmington Hills, MI 48335"}, {"name": "Continental Interiors Inc", "address": "1210 E Maple Rd, Troy, MI 48083"}, {"name": "BEI Architects", "address": "1333 Rochester Rd, Troy, MI 48083"}, {"name": "Eldorado Tile & Marble", "address": "6506 Cotter Ave, Sterling Heights, MI 48314"}, {"name": "Stone Warehouse USA - Michigan", "address": "7235 19 Mile Rd, Sterling Heights, MI 48314"}, {"name": "PMS Brick Pavers We're The Guys", "address": "5540 Bridgewood Dr, Sterling Heights, MI 48310"}, {"name": "Majestic Home Solutions LLC", "address": "42886 Mound Rd, Sterling Heights, MI 48314"}, {"name": "Floorz Supplies Plus INC", "address": "34832 Mound Rd, Sterling Heights, MI 48310"}, {"name": "Floor 4 Life", "address": "34800 Mound Rd, Sterling Heights, MI 48310"}, {"name": "Eastside Tile And Marble", "address": "42700 Mound Rd, Sterling Heights, MI 48314"}, {"name": "Great Lakes Tile & Contracting", "address": "42730 Mound Rd, Sterling Heights, MI 48314"}, {"name": "DAS Architects", "address": "7341 Triangle Dr, Sterling Heights, MI 48314"}, {"name": "The Cabinet Shoppe", "address": "32303 Harper Ave, St Clair Shores, MI 48082"}, {"name": "Woodmaster Kitchens of Michigan", "address": "24420 Harper Ave, St Clair Shores, MI 48080"}, {"name": "Red Baron Enterprises", "address": "20315 E 9 Mile Rd, St Clair Shores, MI 48080"}, {"name": "Rabaut's Interiors", "address": "19513 Mack Ave, Grosse Pointe Woods, MI 48236"}, {"name": "North American Construction Enterprises, LLC", "address": "22920 E Industrial Dr, St Clair Shores, MI 48080"}, {"name": "Arkay-Walker Paint and Interior Design", "address": "27110 Harper Ave, St Clair Shores, MI 48081"}, {"name": "ZeinaDesigns", "address": "29145 Telegraph Rd, Southfield, MI 48034"}, {"name": "Lockwood Companies", "address": "27777 Franklin Rd #1410, Southfield, MI 48034"}, {"name": "Land Design Studio", "address": "18161 13 Mile Rd # B4, Southfield, MI 48076"}, {"name": "GREENWORKS Studio", "address": "28411 Northwestern Hwy #320, Southfield, MI 48034"}, {"name": "Tableau", "address": "50215 Schoenherr Rd, Shelby Township, MI 48315"}, {"name": "Szczesny Floor Covering", "address": "14240 Industrial Center Dr, Shelby Township, MI 48315"}, {"name": "Shelby Floor and Tile", "address": "46511 Van Dyke Ave, Shelby Township, MI 48317"}, {"name": "J M P Design & Build Inc.", "address": "51456 Oro Rd, Shelby Township, MI 48315"}, {"name": "Bobak Construction LLC", "address": "54441 Arrowhead Dr, Shelby Township, MI 48315"}, {"name": "Frank Salamone", "address": "48701 Hayes Rd, Shelby Township, MI 48315"}, {"name": "Anderson, Eckstein & Westrick, Inc.", "address": "51301 Schoenherr Rd, Shelby Township, MI 48315"}, {"name": "Nu-Way Kitchen & Bath", "address": "5227 Auburn Rd, Shelby Township, MI 48317"}, {"name": "Xstyles bath+more", "address": "4812 Delemere Ave, Royal Oak, MI 48076"}, {"name": "Wightman - Royal Oak", "address": "306 S Washington Ave Suite 200, Royal Oak, MI 48067"}, {"name": "Whiski Kitchen Design Studio", "address": "1201 N Main St, Royal Oak, MI 48067"}, {"name": "Von Staden Architects", "address": "504 S Washington Ave, Royal Oak, MI 48067"}, {"name": "TVI Inc.", "address": "28966 Woodward Ave, Royal Oak, MI 48067"}, {"name": "Space Care Interiors", "address": "210 W 6th St, Royal Oak, MI 48067"}, {"name": "Shelter Design Studio", "address": "104 W 4th St #303, Royal Oak, MI 48067"}, {"name": "Richard Ross Designs", "address": "2051 Villa Rd #104, Birmingham, MI 48009"}, {"name": "R J Laney Design", "address": "4535 Fernlee Ave, Royal Oak, MI 48073"}, {"name": "PARTNR HAUS Commercial Interiors", "address": "2120 E 11 Mile Rd, Royal Oak, MI 48067"}, {"name": "Mosher Dolan", "address": "2725 Nakota Rd, Royal Oak, MI 48073"}, {"name": "Moiseev-Gordon & Associates Inc", "address": "4351 Delemere Ct, Royal Oak, MI 48073"}, {"name": "Live Well Custom Homes", "address": "626 E 4th St, Royal Oak, MI 48067"}, {"name": "Krieger Klatt Architects", "address": "400 E Lincoln Ave, Royal Oak, MI 48067"}, {"name": "Jeff Dawkins . Architect", "address": "2565 W Maple Rd #101, Troy, MI 48084"}, {"name": "italmoda Modern Furniture", "address": "950 W Maple Rd, Troy, MI 48084"}, {"name": "ISCG - Haworth Dealer", "address": "612 N Main St, Royal Oak, MI 48067"}, {"name": "GMB", "address": "1041 S Main St #200, Royal Oak, MI 48067"}, {"name": "G H Forbes Associates", "address": "816 E 4th St, Royal Oak, MI 48067"}, {"name": "Executive Kitchens, Inc", "address": "32314 Woodward Ave, Royal Oak, MI 48073"}, {"name": "Detroit Build, Inc.", "address": "1201 N Main St, Royal Oak, MI 48067"}, {"name": "D MET studio architecture and design", "address": "832 W 11 Mile Rd, Royal Oak, MI 48067"}, {"name": "Comprehensive Design Group", "address": "628 E Parent Ave #103, Royal Oak, MI 48067"}, {"name": "Building Detail", "address": "1600 Rochester Rd, Royal Oak, MI 48067"}, {"name": "Bourlier's Barbecue and Fireplace Inc.", "address": "32128 Woodward Ave, Royal Oak, MI 48073"}, {"name": "Art-Harrison Interior Design", "address": "4339 Delemere Blvd, Royal Oak, MI 48073"}, {"name": "Anderson-Miller", "address": "123 S Main St #230, Royal Oak, MI 48067"}, {"name": "Shores Tile Co", "address": "29975 Little Mack Ave, Roseville, MI 48066"}, {"name": "Shock Brothers Floor Covering", "address": "20320 Cornillie Dr, Roseville, MI 48066"}, {"name": "Serra-Marko & Associates", "address": "1055 E South Blvd, Rochester Hills, MI 48307"}, {"name": "Perfect Floors", "address": "1015 John R Rd, Rochester Hills, MI 48307"}, {"name": "Bolyard Lumber & Design", "address": "3770 S Rochester Rd, Rochester Hills, MI 48307"}, {"name": "Mercury Project", "address": "1806 Rochester Industrial Dr #200, Rochester Hills, MI 48309"}, {"name": "Luxury Tile & Marble Co", "address": "3675 W Auburn Rd, Rochester Hills, MI 48309"}, {"name": "L+A Architects", "address": "441 S Livernois Rd #265, Rochester Hills, MI 48307"}, {"name": "EEI Global", "address": "1601 W Hamlin Rd, Rochester Hills, MI 48309"}, {"name": "Design by Choice LLC", "address": "1700 Stutz Dr #104A, Troy, MI 48084"}, {"name": "D'Anna Associates", "address": "1055 E South Blvd #200, Rochester Hills, MI 48307"}, {"name": "Spire Design Group", "address": "115 E 4th St, Rochester, MI 48307"}, {"name": "Niagara Murano LLC", "address": "2215 Cole St, Birmingham, MI 48009"}, {"name": "LoChirco Custom Homes", "address": "202 Walnut Blvd Suite B, Rochester, MI 48307"}, {"name": "Kendal & Company", "address": "1429 N Rochester Rd, Rochester Hills, MI 48307"}, {"name": "French Associates", "address": "236 Mill St, Rochester, MI 48307"}, {"name": "DMJ Interiors", "address": "312 East St, Rochester, MI 48307"}, {"name": "Dillman & Upton", "address": "607 Woodward Ave, Rochester, MI 48307"}, {"name": "Auger Klein Aller Architects", "address": "303 E 3rd St #100, Rochester, MI 48307"}, {"name": "TDG Architects", "address": "79 Oakland Ave, Pontiac, MI 48342"}, {"name": "Studio 5", "address": "40 W Howard St, Pontiac, MI 48342"}, {"name": "Heller & Associates", "address": "7 S Perry St, Pontiac, MI 48342"}, {"name": "Sage Home D\u00e9cor", "address": "795 S Lapeer Rd, Oxford, MI 48371"}, {"name": "All American Floors", "address": "1772 S Ortonville Rd, Ortonville, MI 48462"}, {"name": "PCI-Dailey Company", "address": "21717 Republic Ave, Oak Park, MI 48237"}, {"name": "Alexandria Interiors LLC", "address": "43155 Main St, Novi, MI 48375"}, {"name": "Vistal Homes", "address": "46870 W Seven Mile Rd, Northville, MI 48167"}, {"name": "Martone Design Studio", "address": "120 W Main St, Northville, MI 48167"}, {"name": "GTR Companies LLC", "address": "65 Macomb Pl, Mt Clemens, MI 48043"}, {"name": "Partners in Architecture, PLC", "address": "65 Market St #200, Mt Clemens, MI 48043"}, {"name": "Blackstock Alessandri Associates Llc", "address": "70 Macomb Pl Suite 220, Mt Clemens, MI 48043"}, {"name": "Innovative Corporation Int", "address": "32384 Edward Ave, Madison Heights, MI 48071"}, {"name": "Silva Custom Design LLC", "address": "515 E 10 Mile Rd, Madison Heights, MI 48071"}, {"name": "NCS Construction Services LLC", "address": "876 Horace Brown Dr, Madison Heights, MI 48071"}, {"name": "Namou Hotel Group", "address": "31100 Stephenson Hwy, Madison Heights, MI 48071"}, {"name": "Kitchen & Bath By Rite-Way", "address": "32090 John R Rd, Madison Heights, MI 48071"}, {"name": "Design Fabrications (DFab)", "address": "1100 E Mandoline Ave suite a, Madison Heights, MI 48071"}, {"name": "Heritage Oaks", "address": "51194 Romeo Plank Rd #453, Macomb, MI 48042"}, {"name": "Quicken Stones LLC", "address": "44884 Heydenreich Rd, Clinton Township, MI 48038"}, {"name": "Musante Tile", "address": "48895 Fairchild Rd, Macomb, MI 48042"}, {"name": "Hubert Contracting LLC", "address": "51410 Milano Dr, Macomb, MI 48042"}, {"name": "Cwc Finished Basements", "address": "23035 Angel Park Dr, Macomb, MI 48042"}, {"name": "Blue Mountain Construction Group", "address": "20371 Hall Rd, Macomb, MI 48044"}, {"name": "SAA Architects", "address": "214 S Broadway St, Lake Orion, MI 48362"}, {"name": "AV Design Kitchen + Bath", "address": "169w Clarkston Rd Suite 100, Orion Township, MI 48362"}, {"name": "Stellar Building and Development", "address": "24410 John R Rd, Hazel Park, MI 48030"}, {"name": "Designstruct Inc.", "address": "23617 John R Rd, Hazel Park, MI 48030"}, {"name": "Continental Contracting Co., LLC", "address": "23450 Telegraph Rd, Southfield, MI 48033"}, {"name": "Omega Floors", "address": "35370 Union Lake Rd, Harrison Township, MI 48045"}, {"name": "American Community Developers", "address": "20250 Harper Ave, Harper Woods, MI 48225"}, {"name": "Steven C Flum Inc", "address": "3105 Holbrook, Hamtramck, MI 48212"}, {"name": "Nitsas Interiors", "address": "20445 Mack Ave, Grosse Pointe Woods, MI 48236"}, {"name": "Ann-Marie Anton", "address": "1835 Fleetwood Dr, Grosse Pointe Woods, MI 48236"}, {"name": "Decor and More Design Studio", "address": "319 Fisher Rd, Grosse Pointe, MI 48230"}, {"name": "Diane Woolsey Interiors LLC", "address": "86 Kercheval Ave, Grosse Pointe Farms, MI 48236"}, {"name": "Russo Bennett Associates", "address": "34517 Utica Rd, Fraser, MI 48026"}, {"name": "Rapid Recovery Service", "address": "18377 E 14 Mile Rd, Fraser, MI 48026"}, {"name": "32205 Groesbeck Hwy", "address": "32205 Groesbeck Hwy, Fraser, MI 48026"}, {"name": "CONSTRUCTEAM", "address": "31780 Groesbeck Hwy, Fraser, MI 48026"}, {"name": "Zoyes Creative - Ferndale", "address": "1280 Hilton Rd, Ferndale, MI 48220"}, {"name": "Zoyes Creative - Brand Studio", "address": "2111 Woodward Ave Suite 400, Detroit, MI 48201"}, {"name": "United Building Service Co", "address": "2870 Hilton Rd, Ferndale, MI 48220"}, {"name": "Towers Interior Group", "address": "31500 Northwestern Hwy, Farmington Hills, MI 48334"}, {"name": "Northern Equities Group", "address": "39000 Country Club Dr, Farmington Hills, MI 48331"}, {"name": "MFG Interiors", "address": "39255 Country Club Dr, Farmington Hills, MI 48331"}, {"name": "Interior Image", "address": "37680 Hills Tech Dr, Farmington Hills, MI 48331"}, {"name": "Waldorf Floors LLC", "address": "24798 Crestview, Farmington Hills, MI 48335"}, {"name": "Empire Tile & Marble Co.", "address": "17255 Stephens Rd, Eastpointe, MI 48021"}, {"name": "Sterling Group", "address": "Fort Washington Plaza, 333 W Fort St #1350, Detroit, MI 48226"}, {"name": "Scales & Associates Inc", "address": "28 W Adams Ave # 1100, Detroit, MI 48226"}, {"name": "RVSN Studios", "address": "300 Riverfront Dr, Detroit, MI 48226"}, {"name": "Resendes Design Group", "address": "7451 3rd Ave, Detroit, MI 48202"}, {"name": "Redbird Detroit", "address": "4474 3rd Ave, Detroit, MI 48201"}, {"name": "Populous", "address": "19 Clifford St Suite 08-101, Detroit, MI 48226"}, {"name": "Pophouse", "address": "1150 Griswold St, Detroit, MI 48226"}, {"name": "NXT Design", "address": "1420 Washington Blvd #301, Detroit, MI 48226"}, {"name": "NORR", "address": "150 W Jefferson Ave Suite 1300, Detroit, MI 48226"}, {"name": "M1DTW Architects", "address": "1948 Division St, Detroit, MI 48207"}, {"name": "Las Vegas Stone Flooring Inc", "address": "11343 Schaefer Hwy, Detroit, MI 48227"}, {"name": "Infuz Architects", "address": "1451 Bagley St Suite 7, Detroit, MI 48216"}, {"name": "Harris Design Group", "address": "15 E Kirby St, Detroit, MI 48202"}, {"name": "Hamilton Anderson Associates", "address": "1435 Randolph Street #200, Detroit, MI 48226"}, {"name": "Gensler", "address": "1265 Griswold St, Detroit, MI 48226"}, {"name": "Ferlito Group", "address": "440 Selden St, Detroit, MI 48201"}, {"name": "Et Al Collaborative of Detroit", "address": "2020 14th St, Detroit, MI 48216"}, {"name": "Drinks Design", "address": "1051 Bellevue St, Detroit, MI 48207"}, {"name": "Bedrock", "address": "630 Woodward Ave, Detroit, MI 48226"}, {"name": "Archive Design Studio", "address": "615 Griswold St #916, Detroit, MI 48226"}, {"name": "Albert Kahn Associates, Inc.", "address": "Fisher Bldg, 3011 W Grand Blvd #1800, Detroit, MI 48202"}, {"name": "Winton Flooring and Design", "address": "8348 Richardson Rd, Commerce Township, MI 48382"}, {"name": "Ultra Floors, Inc.", "address": "40210 Hayes Rd, Clinton Township, MI 48038"}, {"name": "SDA Architects", "address": "42490 Garfield Rd Suite 204, Clinton Township, MI 48038"}, {"name": "SBW Architects LLC", "address": "36358 Garfield Rd, Clinton Township, MI 48035"}, {"name": "Leonard C Carnaghi Inc", "address": "24388 Sorrentino Ct, Clinton Township, MI 48035"}, {"name": "Kulbacki Inc", "address": "35480 Forton Ct, Clinton Township, MI 48035"}, {"name": "Gable and Company", "address": "39103 Garfield Rd, Clinton Township, MI 48038"}, {"name": "Innoative Engineered Solutions", "address": "17001 19 Mile Rd, Clinton Township, MI 48038"}, {"name": "Complete Kitchen Design", "address": "33827 Harper Ave, Clinton Township, MI 48035"}, {"name": "Cabinets by Cantu", "address": "44930 Vic Wertz Dr, Clinton Township, MI 48036"}, {"name": "Advanced Landscape & Builders Supply Co.", "address": "890 Rochester Rd, Clawson, MI 48017"}, {"name": "Studio Fraifogl", "address": "6825 Dixie Hwy, Village of Clarkston, MI 48346"}, {"name": "Chris Morgan and Associates", "address": "4435 Newcastle Dr, Village of Clarkston, MI 48348"}, {"name": "Window PlusHome Pro USA", "address": "6490 E 10 Mile Rd, Center Line, MI 48015"}, {"name": "Quarry Gardens", "address": "9376 Marine City Hwy, Casco, MI 48064"}, {"name": "Advance Tile & Marble Inc - Tile Installation with Professional Installers", "address": "3250 Church Rd, Casco, MI 48064"}, {"name": "MWHS", "address": "330 Enterprise Ct, Bloomfield Township, MI 48302"}, {"name": "SLS Designs Inc", "address": "43700 Woodward Ave, Bloomfield Township, MI 48302"}, {"name": "Rariden Schumacher Mio & Co", "address": "35980 Woodward Ave #150, Bloomfield Hills, MI 48304"}, {"name": "Penske Automotive Group, Inc.", "address": "2555 S Telegraph Rd, Bloomfield Hills, MI 48302"}, {"name": "Marusich Architecture", "address": "36880 Woodward Ave, Bloomfield Hills, MI 48304"}, {"name": "Kojaian Management Corporation", "address": "39400 Woodward Ave #250, Bloomfield Hills, MI 48304"}, {"name": "Hunter Roberts Homes", "address": "36800 Woodward Ave #200, Bloomfield Hills, MI 48304"}, {"name": "Edward Rose & Sons", "address": "38525 Woodward Ave, Bloomfield Hills, MI 48304"}, {"name": "Dokan Construction", "address": "42690 Woodward Ave, Bloomfield Hills, MI 48304"}, {"name": "Contour Companies", "address": "40950 Woodward Ave #300, Bloomfield Hills, MI 48304"}, {"name": "McLeod Carpet One Floor & Home", "address": "42598 Woodward Ave, Bloomfield Hills, MI 48304"}, {"name": "111 S Old Woodward Ave", "address": "111 S Old Woodward Ave, Birmingham, MI 48009"}, {"name": "JSK Design", "address": "31333 Southfield Rd, Beverly Hills, MI 48025"}, {"name": "Saroki Architecture", "address": "430 N Old Woodward Ave, Birmingham, MI 48009"}, {"name": "Sanda Johnstone Design Association", "address": "950 E Maple Rd, Birmingham, MI 48009"}, {"name": "Ron & Roman LLC", "address": "275 E Frank St, Birmingham, MI 48009"}, {"name": "Posh Interior Studios", "address": "107 Townsend St, Birmingham, MI 48009"}, {"name": "Pazzi Inc", "address": "395 E Maple Rd, Birmingham, MI 48009"}, {"name": "NH Ziegelman Architects LLC", "address": "800 N Old Woodward Ave, Birmingham, MI 48009"}, {"name": "Michael Willoughby & Associates-Architects", "address": "880 S Old Woodward Ave #210, Birmingham, MI 48009"}, {"name": "Merien Daka Design Group", "address": "187 S Old Woodward Ave # 250, Birmingham, MI 48009"}, {"name": "Meg Corley Interiors", "address": "2051 Villa Rd #105, Birmingham, MI 48009"}, {"name": "McIntosh Poris Architects", "address": "36801 Woodward Ave, Birmingham, MI 48009"}, {"name": "Marianne Jones Interior Design", "address": "2003 Cole St, Birmingham, MI 48009"}, {"name": "Luckenbach Ziegelman Architects", "address": "555 S Old Woodward Ave Suite 27L, Birmingham, MI 48009"}, {"name": "Kevin Hart Associates", "address": "405 S Eton St, Birmingham, MI 48009"}, {"name": "Jeffrey King Interiors", "address": "2253 Cole St, Birmingham, MI 48009"}, {"name": "James Douglas Interiors LLC - Interior Designs", "address": "2007 Cole St, Birmingham, MI 48009"}, {"name": "Homework Interiors", "address": "s Rail District, 2239 Cole St, Birmingham, MI 48009"}, {"name": "Gregory Aerts & Associates", "address": "132 N Old Woodward Ave, Birmingham, MI 48009"}, {"name": "Glenda Meads Architects", "address": "114 S Old Woodward Ave, Birmingham, MI 48009"}, {"name": "Designs Unlimited Custom Cabinetry", "address": "104 Willits St, Birmingham, MI 48009"}, {"name": "DesignTeam Plus, Inc.", "address": "975 E Maple Rd #210, Birmingham, MI 48009"}, {"name": "De Giulio Kitchen Studio", "address": "34222 Woodward Ave, Birmingham, MI 48009"}, {"name": "Craig Steinhous & Associates Inc", "address": "187 S Old Woodward Ave, Birmingham, MI 48009"}, {"name": "Brookside Residences", "address": "369 N Old Woodward Ave, Birmingham, MI 48009"}, {"name": "Brian Neeper Architecture", "address": "259 E Frank St, Birmingham, MI 48009"}, {"name": "Birmingham Kitchen Baths", "address": "363 E Maple Rd, Birmingham, MI 48009"}, {"name": "PDC Designs", "address": "31455 Southfield Rd, Beverly Hills, MI 48025"}, {"name": "Kalabat Development & Construction", "address": "31333 Southfield Rd Suite 250, Beverly Hills, MI 48025"}, {"name": "Gala & Associates Inc", "address": "31455 Southfield Rd # 202, Beverly Hills, MI 48025"}, {"name": "William Ellis Co", "address": "3311 12 Mile Rd #2, Berkley, MI 48072"}, {"name": "D & S Contractors", "address": "3500 W Eleven Mile Rd, Berkley, MI 48072"}, {"name": "Cobblestone Kitchen & Bath", "address": "3311 12 Mile Rd, Berkley, MI 48072"}, {"name": "Avenue Group Real Estate", "address": "2985 12 Mile Rd, Berkley, MI 48072"}, {"name": "Finished Spaces LLC", "address": "3300 Auburn Rd Suite #210, Auburn Hills, MI 48326"}, {"name": "Fieldstone Architecture & Engineering", "address": "3400 Auburn Rd #200, Auburn Hills, MI 48326"}, {"name": "Romeo Kitchen & Bath LLC", "address": "80720 Capac Rd, Armada, MI 48005"}, {"name": "Designhaus Architecture", "address": "3300 Auburn Rd Suite 300, Auburn Hills, MI 48326"}, {"name": "Thompson-Phelan Group Inc", "address": "9834 Dixie Hwy, Ira Township, MI 48023"}];

        // Zone colors
        const ZONE_COLORS = [
            '#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16',
            '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9',
            '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef',
            '#ec4899', '#f43f5e', '#78716c', '#71717a', '#64748b',
            '#0d9488', '#7c3aed', '#2563eb', '#dc2626', '#ca8a04'
        ];

        // ========== STATE ==========
        let currentUser = null;
        let isOwner = false;
        let locations = [];
        let zones = [];
        let map = null;
        let markers = [];
        let maxPerZone = 15;
        let editingLocationIndex = null;
        let editingZoneIndex = null;

        // ========== GEOCODING ==========
        async function geocodeAddress(address) {
            try {
                const encoded = encodeURIComponent(address);
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encoded}&limit=1`);
                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            return null;
        }

        async function geocodeAllLocations() {
            showToast('Geocoding addresses... This may take a moment.');

            for (let i = 0; i < locations.length; i++) {
                if (!locations[i].lat || !locations[i].lng) {
                    const coords = await geocodeAddress(locations[i].address);
                    if (coords) {
                        locations[i].lat = coords.lat;
                        locations[i].lng = coords.lng;
                    }
                    // Rate limiting for Nominatim
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            saveUserData();
            showToast('Geocoding complete!');
        }

        // ========== CLUSTERING & ZONES ==========
        function calculateDistance(loc1, loc2) {
            const R = 3959; // Earth radius in miles
            const dLat = (loc2.lat - loc1.lat) * Math.PI / 180;
            const dLon = (loc2.lng - loc1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(loc1.lat * Math.PI / 180) * Math.cos(loc2.lat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function clusterLocations() {
            // Filter locations with valid coordinates
            const validLocations = locations.filter(l => l.lat && l.lng);

            if (validLocations.length === 0) {
                zones = [];
                return;
            }

            // Keep manually assigned zones, cluster the rest
            const manuallyAssigned = locations.filter(l => l.manualZone !== undefined && l.manualZone !== null);
            const toCluster = locations.filter(l => (l.manualZone === undefined || l.manualZone === null) && l.lat && l.lng);

            // Simple k-means-like clustering
            const targetZones = Math.min(25, Math.ceil(toCluster.length / maxPerZone));

            if (targetZones === 0 && manuallyAssigned.length === 0) {
                zones = [];
                return;
            }

            // Initialize zones based on existing or create new
            const existingZoneNames = zones.map(z => z.name);

            if (toCluster.length > 0) {
                // Initialize centroids spread across the data
                let centroids = [];
                const step = Math.floor(toCluster.length / targetZones);

                for (let i = 0; i < targetZones && i * step < toCluster.length; i++) {
                    centroids.push({
                        lat: toCluster[i * step].lat,
                        lng: toCluster[i * step].lng
                    });
                }

                // K-means iterations
                for (let iter = 0; iter < 10; iter++) {
                    // Assign each location to nearest centroid
                    let assignments = new Array(toCluster.length);

                    for (let i = 0; i < toCluster.length; i++) {
                        let minDist = Infinity;
                        let closestZone = 0;

                        for (let j = 0; j < centroids.length; j++) {
                            const dist = calculateDistance(toCluster[i], centroids[j]);
                            if (dist < minDist) {
                                minDist = dist;
                                closestZone = j;
                            }
                        }

                        assignments[i] = closestZone;
                    }

                    // Check zone sizes and reassign if over max
                    const zoneCounts = new Array(centroids.length).fill(0);
                    assignments.forEach(z => zoneCounts[z]++);

                    for (let i = 0; i < toCluster.length; i++) {
                        if (zoneCounts[assignments[i]] > maxPerZone) {
                            // Find next best zone that's not full
                            let distances = centroids.map((c, idx) => ({
                                idx,
                                dist: calculateDistance(toCluster[i], c)
                            })).sort((a, b) => a.dist - b.dist);

                            for (let d of distances) {
                                if (zoneCounts[d.idx] < maxPerZone) {
                                    zoneCounts[assignments[i]]--;
                                    assignments[i] = d.idx;
                                    zoneCounts[d.idx]++;
                                    break;
                                }
                            }
                        }
                    }

                    // Update centroids
                    centroids = centroids.map((_, zoneIdx) => {
                        const zoneLocations = toCluster.filter((_, i) => assignments[i] === zoneIdx);
                        if (zoneLocations.length === 0) return centroids[zoneIdx];
                        return {
                            lat: zoneLocations.reduce((s, l) => s + l.lat, 0) / zoneLocations.length,
                            lng: zoneLocations.reduce((s, l) => s + l.lng, 0) / zoneLocations.length
                        };
                    });

                    // Assign zones to locations
                    for (let i = 0; i < toCluster.length; i++) {
                        const locIndex = locations.findIndex(l => l.name === toCluster[i].name && l.address === toCluster[i].address);
                        if (locIndex !== -1) {
                            locations[locIndex].zone = assignments[i];
                        }
                    }
                }
            }

            // Build zones array
            const usedZones = new Set(locations.filter(l => l.zone !== undefined).map(l => l.zone));
            if (manuallyAssigned.length > 0) {
                manuallyAssigned.forEach(l => usedZones.add(l.manualZone));
            }

            const maxZone = Math.max(...Array.from(usedZones), -1);

            zones = [];
            for (let i = 0; i <= maxZone; i++) {
                if (usedZones.has(i)) {
                    const existingZone = zones.find(z => z.id === i);
                    zones.push({
                        id: i,
                        name: existingZone?.name || `Zone ${i + 1}`,
                        color: ZONE_COLORS[i % ZONE_COLORS.length]
                    });
                }
            }

            // Apply manual zone assignments
            manuallyAssigned.forEach(l => {
                const locIndex = locations.findIndex(loc => loc.name === l.name && loc.address === l.address);
                if (locIndex !== -1) {
                    locations[locIndex].zone = l.manualZone;
                }
            });
        }

        function recalibrateZones() {
            // Clear manual assignments
            locations.forEach(l => {
                delete l.manualZone;
            });

            clusterLocations();
            saveUserData();
            renderAll();
            showToast('Zones recalibrated!');
        }

        // ========== USER MANAGEMENT ==========
        function switchLoginTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
        }

        function login() {
            const username = document.getElementById('loginUsername').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showToast('Please enter username and password');
                return;
            }

            // Check owner credentials
            if (username === OWNER_CREDENTIALS.username && password === OWNER_CREDENTIALS.password) {
                currentUser = username;
                isOwner = true;
                loadOwnerData();
                showMainApp();
                return;
            }

            // Check stored users
            const users = JSON.parse(localStorage.getItem('zoneMapUsers') || '{}');
            if (users[username] && users[username].password === password) {
                currentUser = username;
                isOwner = false;
                loadUserData();
                showMainApp();
            } else {
                showToast('Invalid credentials');
            }
        }

        function register() {
            const username = document.getElementById('regUsername').value.trim().toLowerCase();
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regConfirmPassword').value;

            if (!username || !password) {
                showToast('Please fill all fields');
                return;
            }

            if (password !== confirm) {
                showToast('Passwords do not match');
                return;
            }

            if (username === OWNER_CREDENTIALS.username) {
                showToast('Username not available');
                return;
            }

            const users = JSON.parse(localStorage.getItem('zoneMapUsers') || '{}');
            if (users[username]) {
                showToast('Username already exists');
                return;
            }

            users[username] = {
                password: password,
                locations: [],
                zones: [],
                maxPerZone: 15
            };

            localStorage.setItem('zoneMapUsers', JSON.stringify(users));

            currentUser = username;
            isOwner = false;
            locations = [];
            zones = [];
            maxPerZone = 15;

            showMainApp();
            showToast('Account created successfully!');
        }

        function continueAsGuest() {
            currentUser = 'guest_' + Date.now();
            isOwner = false;
            locations = [];
            zones = [];
            maxPerZone = 15;
            showMainApp();
        }

        function logout() {
            currentUser = null;
            isOwner = false;
            locations = [];
            zones = [];

            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');

            // Clear login fields
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function loadOwnerData() {
            const saved = localStorage.getItem('zoneMapOwnerData');
            if (saved) {
                const data = JSON.parse(saved);
                locations = data.locations || [];
                zones = data.zones || [];
                maxPerZone = data.maxPerZone || 15;
            } else {
                // First time owner login - load preset data
                locations = PRESET_LOCATIONS.map((l, i) => ({...l, zone: null}));
                zones = [];
                maxPerZone = 15;
            }
        }

        function loadUserData() {
            const users = JSON.parse(localStorage.getItem('zoneMapUsers') || '{}');
            if (users[currentUser]) {
                locations = users[currentUser].locations || [];
                zones = users[currentUser].zones || [];
                maxPerZone = users[currentUser].maxPerZone || 15;
            }
        }

        function saveUserData() {
            if (!currentUser || currentUser.startsWith('guest_')) return;

            if (isOwner) {
                localStorage.setItem('zoneMapOwnerData', JSON.stringify({
                    locations,
                    zones,
                    maxPerZone
                }));
            } else {
                const users = JSON.parse(localStorage.getItem('zoneMapUsers') || '{}');
                users[currentUser] = {
                    ...users[currentUser],
                    locations,
                    zones,
                    maxPerZone
                };
                localStorage.setItem('zoneMapUsers', JSON.stringify(users));
            }
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            document.getElementById('userDisplay').textContent = `Welcome, ${currentUser}${isOwner ? ' (Owner)' : ''}`;
            document.getElementById('maxPerZone').value = maxPerZone;

            initMap();

            // If owner and first time, geocode locations
            if (isOwner && locations.some(l => !l.lat || !l.lng)) {
                geocodeAllLocations().then(() => {
                    clusterLocations();
                    saveUserData();
                    renderAll();
                });
            } else {
                if (locations.length > 0 && zones.length === 0) {
                    clusterLocations();
                }
                renderAll();
            }
        }

        // ========== MAP ==========
        function initMap() {
            if (map) {
                map.remove();
            }

            map = L.map('map').setView([42.5, -83.2], 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        function renderMap() {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            // Add markers for each location
            locations.forEach((loc, index) => {
                if (!loc.lat || !loc.lng) return;

                const zoneColor = loc.zone !== undefined && zones[loc.zone] 
                    ? zones[loc.zone].color 
                    : '#6b7280';

                const marker = L.circleMarker([loc.lat, loc.lng], {
                    radius: 8,
                    fillColor: zoneColor,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                const zoneName = loc.zone !== undefined && zones[loc.zone] 
                    ? zones[loc.zone].name 
                    : 'Unassigned';

                marker.bindPopup(`
                    <div class="popup-content">
                        <h4>${loc.name}</h4>
                        <p>${loc.address}</p>
                        <p><strong>Zone:</strong> ${zoneName}</p>
                        <button class="btn btn-primary" onclick="openEditModal(${index})">Edit Location</button>
                    </div>
                `);

                markers.push(marker);
            });

            // Fit bounds if we have locations
            const validLocs = locations.filter(l => l.lat && l.lng);
            if (validLocs.length > 0) {
                const bounds = L.latLngBounds(validLocs.map(l => [l.lat, l.lng]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // ========== RENDERING ==========
        function renderAll() {
            renderMap();
            renderZoneList();
            renderAddressList();
        }

        function renderZoneList() {
            const container = document.getElementById('zoneList');

            if (zones.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.9rem;">No zones created yet</p>';
                return;
            }

            container.innerHTML = zones.map((zone, index) => {
                const count = locations.filter(l => l.zone === index).length;
                return `
                    <div class="zone-item" onclick="focusZone(${index})">
                        <div class="zone-color" style="background: ${zone.color}"></div>
                        <span class="zone-name">${zone.name}</span>
                        <span class="zone-count">${count}</span>
                        <div class="zone-actions">
                            <button class="zone-btn" onclick="event.stopPropagation(); openEditZoneModal(${index})" title="Edit">‚úèÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAddressList() {
            const container = document.getElementById('addressList');
            const sortBy = document.getElementById('sortBy').value;

            document.getElementById('locationCount').textContent = locations.length;

            if (locations.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No locations added yet</p>';
                return;
            }

            // Sort locations
            let sorted = [...locations].map((l, i) => ({...l, originalIndex: i}));

            if (sortBy === 'name') {
                sorted.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortBy === 'zone') {
                sorted.sort((a, b) => (a.zone || 999) - (b.zone || 999));
            } else if (sortBy === 'address') {
                sorted.sort((a, b) => a.address.localeCompare(b.address));
            }

            container.innerHTML = sorted.map(loc => {
                const zoneColor = loc.zone !== undefined && zones[loc.zone] 
                    ? zones[loc.zone].color 
                    : '#6b7280';
                const zoneName = loc.zone !== undefined && zones[loc.zone] 
                    ? zones[loc.zone].name 
                    : 'Unassigned';

                return `
                    <div class="address-item">
                        <div class="address-zone-color" style="background: ${zoneColor}"></div>
                        <div class="address-info">
                            <div class="address-name">${loc.name}</div>
                            <div class="address-details">${loc.address} | ${zoneName}</div>
                        </div>
                        <div class="address-actions">
                            <button class="btn btn-secondary" onclick="openEditModal(${loc.originalIndex})">Recalibrate</button>
                            <button class="btn btn-danger" onclick="deleteLocation(${loc.originalIndex})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== MODALS ==========
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function openAddAddressModal() {
            editingLocationIndex = null;
            document.getElementById('editModalTitle').textContent = 'Add Location';
            document.getElementById('editName').value = '';
            document.getElementById('editAddress').value = '';
            document.getElementById('editLat').value = '';
            document.getElementById('editLng').value = '';

            updateZoneSelect();
            document.getElementById('editZone').value = 'auto';

            openModal('editModal');
        }

        function openEditModal(index) {
            editingLocationIndex = index;
            const loc = locations[index];

            document.getElementById('editModalTitle').textContent = 'Edit Location';
            document.getElementById('editName').value = loc.name;
            document.getElementById('editAddress').value = loc.address;
            document.getElementById('editLat').value = loc.lat || '';
            document.getElementById('editLng').value = loc.lng || '';

            updateZoneSelect();
            document.getElementById('editZone').value = loc.manualZone !== undefined ? loc.manualZone : 'auto';

            openModal('editModal');
        }

        function updateZoneSelect() {
            const select = document.getElementById('editZone');
            select.innerHTML = '<option value="auto">Auto-assign</option>';

            zones.forEach((zone, index) => {
                select.innerHTML += `<option value="${index}">${zone.name}</option>`;
            });
        }

        async function saveLocation() {
            const name = document.getElementById('editName').value.trim();
            const address = document.getElementById('editAddress').value.trim();
            let lat = parseFloat(document.getElementById('editLat').value) || null;
            let lng = parseFloat(document.getElementById('editLng').value) || null;
            const zoneSelection = document.getElementById('editZone').value;

            if (!name || !address) {
                showToast('Please enter name and address');
                return;
            }

            // Auto-geocode if coordinates not provided
            if (!lat || !lng) {
                showToast('Geocoding address...');
                const coords = await geocodeAddress(address);
                if (coords) {
                    lat = coords.lat;
                    lng = coords.lng;
                } else {
                    showToast('Could not geocode address. Please enter coordinates manually.');
                    return;
                }
            }

            const locationData = {
                name,
                address,
                lat,
                lng,
                zone: null,
                manualZone: zoneSelection !== 'auto' ? parseInt(zoneSelection) : undefined
            };

            if (editingLocationIndex !== null) {
                locations[editingLocationIndex] = locationData;
            } else {
                locations.push(locationData);
            }

            clusterLocations();
            saveUserData();
            renderAll();
            closeModal('editModal');
            showToast('Location saved!');
        }

        function deleteLocation(index) {
            if (confirm('Are you sure you want to delete this location?')) {
                locations.splice(index, 1);
                clusterLocations();
                saveUserData();
                renderAll();
                showToast('Location deleted');
            }
        }

        function openAddZoneModal() {
            editingZoneIndex = null;
            document.getElementById('zoneModalTitle').textContent = 'Add Zone';
            document.getElementById('zoneName').value = '';
            document.getElementById('zoneColor').value = ZONE_COLORS[zones.length % ZONE_COLORS.length];
            document.getElementById('deleteZoneBtn').classList.add('hidden');
            openModal('zoneModal');
        }

        function openEditZoneModal(index) {
            editingZoneIndex = index;
            const zone = zones[index];

            document.getElementById('zoneModalTitle').textContent = 'Edit Zone';
            document.getElementById('zoneName').value = zone.name;
            document.getElementById('zoneColor').value = zone.color;
            document.getElementById('deleteZoneBtn').classList.remove('hidden');

            openModal('zoneModal');
        }

        function saveZone() {
            const name = document.getElementById('zoneName').value.trim();
            const color = document.getElementById('zoneColor').value;

            if (!name) {
                showToast('Please enter a zone name');
                return;
            }

            if (editingZoneIndex !== null) {
                zones[editingZoneIndex].name = name;
                zones[editingZoneIndex].color = color;
            } else {
                zones.push({
                    id: zones.length,
                    name,
                    color
                });
            }

            saveUserData();
            renderAll();
            closeModal('zoneModal');
            showToast('Zone saved!');
        }

        function deleteZone() {
            if (editingZoneIndex === null) return;

            if (confirm('Are you sure? Locations in this zone will be reassigned.')) {
                // Clear zone assignment for affected locations
                locations.forEach(l => {
                    if (l.zone === editingZoneIndex) {
                        l.zone = null;
                        delete l.manualZone;
                    } else if (l.zone > editingZoneIndex) {
                        l.zone--;
                        if (l.manualZone !== undefined && l.manualZone > editingZoneIndex) {
                            l.manualZone--;
                        }
                    }
                });

                zones.splice(editingZoneIndex, 1);
                clusterLocations();
                saveUserData();
                renderAll();
                closeModal('zoneModal');
                showToast('Zone deleted');
            }
        }

        // ========== ACTIONS ==========
        function focusZone(zoneIndex) {
            const zoneLocations = locations.filter(l => l.zone === zoneIndex && l.lat && l.lng);
            if (zoneLocations.length > 0) {
                const bounds = L.latLngBounds(zoneLocations.map(l => [l.lat, l.lng]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function updateMaxPerZone() {
            maxPerZone = parseInt(document.getElementById('maxPerZone').value) || 15;
            clusterLocations();
            saveUserData();
            renderAll();
            showToast(`Max per zone updated to ${maxPerZone}`);
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ========== INIT ==========
        // Check for existing session
        window.addEventListener('DOMContentLoaded', () => {
            // App starts on login page by default
        });
    </script>
</body>
</html>